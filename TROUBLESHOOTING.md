# PandaWiki æ•…éšœæ’é™¤æŒ‡å—

æœ¬æ–‡æ¡£è®°å½•äº†PandaWikiå¼€å‘å’Œéƒ¨ç½²è¿‡ç¨‹ä¸­å¸¸è§é—®é¢˜çš„è¯Šæ–­å’Œè§£å†³æ–¹æ¡ˆã€‚

## ğŸ“‹ ç›®å½•

1. [çŸ¥è¯†åº“ç›¸å…³é—®é¢˜](#çŸ¥è¯†åº“ç›¸å…³é—®é¢˜)
2. [Caddyä»£ç†é—®é¢˜](#caddyä»£ç†é—®é¢˜)
3. [å‰ç«¯æœåŠ¡é—®é¢˜](#å‰ç«¯æœåŠ¡é—®é¢˜)
4. [åç«¯APIé—®é¢˜](#åç«¯apié—®é¢˜)
5. [æ•°æ®åº“é—®é¢˜](#æ•°æ®åº“é—®é¢˜)
6. [æœåŠ¡ç®¡ç†é—®é¢˜](#æœåŠ¡ç®¡ç†é—®é¢˜)

---

## ğŸ—‚ï¸ çŸ¥è¯†åº“ç›¸å…³é—®é¢˜

### âŒ é—®é¢˜ï¼šåˆ›å»ºçŸ¥è¯†åº“å¤±è´¥ - "kb is too many"

**ç—‡çŠ¶**ï¼š
- åœ¨ç®¡ç†ç•Œé¢åˆ›å»ºçŸ¥è¯†åº“æ—¶æç¤º"kb is too many"
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š`failed to create knowledge base: kb is too many`

**åŸå› **ï¼š
ç³»ç»Ÿåœ¨ `backend/repo/pg/knowledge_base.go` ä¸­ç¡¬ç¼–ç äº†çŸ¥è¯†åº“æ•°é‡é™åˆ¶ï¼š
```go
if len(kbs) > 1 {
    return errors.New("kb is too many")
}
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
å·²ä¿®å¤æ­¤é—®é¢˜ï¼Œç§»é™¤äº†æ•°é‡é™åˆ¶ã€‚å¦‚æœä»é‡åˆ°æ­¤é—®é¢˜ï¼š

1. æ£€æŸ¥ä»£ç æ˜¯å¦å·²æ›´æ–°ï¼š
```bash
grep -n "kb is too many" backend/repo/pg/knowledge_base.go
```

2. å¦‚æœä»å­˜åœ¨é™åˆ¶ï¼Œæ‰‹åŠ¨æ³¨é‡Šç›¸å…³ä»£ç å¹¶é‡å¯åç«¯æœåŠ¡

---

## ğŸŒ Caddyä»£ç†é—®é¢˜

### âŒ é—®é¢˜ï¼šçŸ¥è¯†åº“ç«¯å£æ— æ³•è®¿é—® (8089, 8090ç­‰)

**ç—‡çŠ¶**ï¼š
- è®¿é—® http://localhost:8089 è¿”å›è¿æ¥æ‹’ç»é”™è¯¯
- æˆ–è€…è¿”å›404é¡µé¢æ˜¾ç¤º"é¡µé¢ä¸å­˜åœ¨"

**è¯Šæ–­æ­¥éª¤**ï¼š

1. **æ£€æŸ¥CaddyæœåŠ¡çŠ¶æ€**ï¼š
```bash
./caddy-manager.sh status
```

2. **æ£€æŸ¥ç«¯å£ç›‘å¬**ï¼š
```bash
netstat -tlnp | grep -E ":(8089|8090)"
```

3. **æŸ¥çœ‹Caddyæ—¥å¿—**ï¼š
```bash
tail -f logs/caddy.log
```

**å¸¸è§åŸå› å’Œè§£å†³æ–¹æ¡ˆ**ï¼š

#### åŸå› 1ï¼šCaddyé…ç½®è¯­æ³•é”™è¯¯
**ç—‡çŠ¶**ï¼šæ—¥å¿—æ˜¾ç¤º `unrecognized parameter 'listen'` ç­‰è¯­æ³•é”™è¯¯

**è§£å†³**ï¼š
```bash
# éªŒè¯é…ç½®æ–‡ä»¶
./caddy-manager.sh validate

# é‡å¯æœåŠ¡
./caddy-manager.sh restart
```

#### åŸå› 2ï¼šCaddyç®¡ç†APIæœªå¯åŠ¨
**ç—‡çŠ¶**ï¼š`/app/run/caddy-admin.sock` æ–‡ä»¶ä¸å­˜åœ¨

**è§£å†³**ï¼š
```bash
# å®Œå…¨é‡å¯CaddyæœåŠ¡
./caddy-manager.sh stop
./caddy-manager.sh start
```

#### åŸå› 3ï¼šåŠ¨æ€é…ç½®åŒæ­¥å¤±è´¥
**ç—‡çŠ¶**ï¼šåç«¯æ—¥å¿—æ˜¾ç¤º `failed to sync kb access settings to caddy`

**è§£å†³**ï¼š
1. ç¡®ä¿Caddyç®¡ç†APIå¯ç”¨
2. é‡å¯åç«¯æœåŠ¡è§¦å‘é‡æ–°åŒæ­¥ï¼š
```bash
# åœæ­¢åç«¯
lsof -ti:8000 | xargs kill -9

# é‡å¯åç«¯
cd backend && go run ./cmd/api > ../logs/backend.log 2>&1 &
```

---

## ğŸ–¥ï¸ å‰ç«¯æœåŠ¡é—®é¢˜

### âŒ é—®é¢˜ï¼šç”¨æˆ·å‰å°APIè¿æ¥é”™è¯¯

**ç—‡çŠ¶**ï¼š
- æµè§ˆå™¨å¼€å‘è€…å·¥å…·æ˜¾ç¤ºAPIè¯·æ±‚å¤±è´¥
- ç”¨æˆ·å‰å°æ—¥å¿—æ˜¾ç¤ºè¿æ¥åˆ°é”™è¯¯åœ°å€ï¼š`http://panda-wiki-api:8000`
- é¡µé¢æ˜¾ç¤º404æˆ–åŠ è½½å¤±è´¥

**åŸå› **ï¼š
ç”¨æˆ·å‰å°æœåŠ¡ä½¿ç”¨äº†é”™è¯¯çš„APIåœ°å€ç¯å¢ƒå˜é‡ï¼Œåº”è¯¥è¿æ¥åˆ° `localhost:8000` è€Œä¸æ˜¯ `panda-wiki-api:8000`ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š

1. **ä½¿ç”¨ä¿®å¤è„šæœ¬**ï¼š
```bash
./restart-frontend.sh
```

2. **æ‰‹åŠ¨ä¿®å¤**ï¼š
```bash
# åœæ­¢ç”¨æˆ·å‰å°æœåŠ¡
kill $(cat pids/app.pid)

# è®¾ç½®æ­£ç¡®çš„ç¯å¢ƒå˜é‡å¹¶é‡å¯
cd web/app
export NEXT_PUBLIC_API_URL=http://localhost:8000
npm run dev > ../../logs/app.log 2>&1 &
echo $! > ../../pids/app.pid
cd ../..
```

3. **éªŒè¯ä¿®å¤**ï¼š
æ£€æŸ¥æ—¥å¿—åº”è¯¥æ˜¾ç¤ºè¿æ¥åˆ°æ­£ç¡®åœ°å€ï¼š
```bash
tail -f logs/app.log | grep "request url"
```

---

## ğŸ”§ åç«¯APIé—®é¢˜

### âŒ é—®é¢˜ï¼šCaddyåŒæ­¥é…ç½®å¤±è´¥

**ç—‡çŠ¶**ï¼š
- åç«¯æ—¥å¿—æ˜¾ç¤ºï¼š`failed to sync kb access settings to caddy`
- åˆ›å»ºçŸ¥è¯†åº“æ—¶æ— æ³•è‡ªåŠ¨é…ç½®ä»£ç†

**è¯Šæ–­**ï¼š
```bash
# æ£€æŸ¥Caddyç®¡ç†å¥—æ¥å­—
ls -la /app/run/caddy-admin.sock

# æµ‹è¯•ç®¡ç†API
curl -s --unix-socket /app/run/caddy-admin.sock "http://localhost/config/"
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿CaddyæœåŠ¡æ­£å¸¸è¿è¡Œå¹¶å¯ç”¨äº†ç®¡ç†API
2. ä½¿ç”¨æ–¹æ¡ˆAçš„ä¿®å¤ï¼ˆå·²å®æ–½ï¼‰ï¼šå¿½ç•¥CaddyåŒæ­¥é”™è¯¯ï¼Œä¸ä¸­æ–­ä¸šåŠ¡æµç¨‹

---

## ğŸ—„ï¸ æ•°æ®åº“é—®é¢˜

### âŒ é—®é¢˜ï¼šæ¨¡å‹é‡å¤é”®é”™è¯¯

**ç—‡çŠ¶**ï¼š
- åç«¯å¯åŠ¨æ—¶æŠ¥é”™ï¼š`duplicated key not allowed`
- æ—¥å¿—æ˜¾ç¤ºæ’å…¥BaiZhiCloudæ¨¡å‹æ—¶å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# ä½¿ç”¨æ•°æ®åº“æ¸…ç†è„šæœ¬
./clean-database.sh

# æˆ–æ‰‹åŠ¨æ¸…ç†
PGPASSWORD="panda-wiki-secret" psql -h localhost -U panda-wiki -d panda-wiki -c "DELETE FROM models WHERE provider='BaiZhiCloud';"
```

---

## âš™ï¸ æœåŠ¡ç®¡ç†é—®é¢˜

### âŒ é—®é¢˜ï¼šstop-all.shæ— æ³•å®Œå…¨åœæ­¢æœåŠ¡

**ç—‡çŠ¶**ï¼š
- è¿è¡Œstop-all.shåï¼ŒæŸäº›ç«¯å£ä»è¢«å ç”¨
- ç‰¹åˆ«æ˜¯8000ç«¯å£(åç«¯API)æ— æ³•å®Œå…¨æ¸…ç†

**åŸå› **ï¼š
ä½¿ç”¨ `go run` å¯åŠ¨çš„æœåŠ¡ä¼šäº§ç”Ÿçˆ¶è¿›ç¨‹å’Œå­è¿›ç¨‹ï¼Œåœæ­¢è„šæœ¬åªæ€æ­»äº†çˆ¶è¿›ç¨‹ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
å·²ä¿®å¤stop-all.shè„šæœ¬ï¼Œç°åœ¨ä¼šï¼š
1. åœæ­¢PIDæ–‡ä»¶ä¸­çš„è¿›ç¨‹
2. æ ¹æ®ç«¯å£å¼ºåˆ¶æ¸…ç†é—ç•™è¿›ç¨‹
3. æ¸…ç†go runç¼–è¯‘çš„ä¸´æ—¶å¯æ‰§è¡Œæ–‡ä»¶

**éªŒè¯ä¿®å¤**ï¼š
```bash
# è¿è¡Œåœæ­¢è„šæœ¬
./stop-all.sh

# æ£€æŸ¥ç«¯å£æ˜¯å¦å®Œå…¨é‡Šæ”¾
lsof -i:8000,8080,5173,3010,8089
```

---

## ğŸ”§ å®ç”¨å·¥å…·å’Œè„šæœ¬

### Caddyç®¡ç†
```bash
# å¯åŠ¨/åœæ­¢/é‡å¯CaddyæœåŠ¡
./caddy-manager.sh {start|stop|restart|status|validate}
```

### å‰ç«¯é—®é¢˜ä¿®å¤
```bash
# ä¿®å¤å‰ç«¯APIè¿æ¥é—®é¢˜
./restart-frontend.sh
```

### æœåŠ¡çŠ¶æ€æ£€æŸ¥
```bash
# æ£€æŸ¥æ‰€æœ‰æœåŠ¡çŠ¶æ€
./status.sh

# æ£€æŸ¥ç‰¹å®šç«¯å£
netstat -tlnp | grep :8000
```

### æ—¥å¿—æŸ¥çœ‹
```bash
# å®æ—¶æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f logs/backend.log

# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
tail -f logs/*.log
```

---

## ğŸš¨ ç´§æ€¥ä¿®å¤æµç¨‹

å½“é‡åˆ°æœåŠ¡å¼‚å¸¸æ—¶ï¼ŒæŒ‰ä»¥ä¸‹é¡ºåºæ“ä½œï¼š

1. **åœæ­¢æ‰€æœ‰æœåŠ¡**ï¼š
```bash
./stop-all.sh
```

2. **æ£€æŸ¥ç«¯å£é‡Šæ”¾**ï¼š
```bash
lsof -i:8000,8080,5173,3010,8089,8090
```

3. **é‡æ–°å¯åŠ¨æœåŠ¡**ï¼š
```bash
./start-all.sh
```

4. **éªŒè¯æœåŠ¡çŠ¶æ€**ï¼š
```bash
./status.sh
```

5. **å¦‚æœCaddyç›¸å…³é—®é¢˜**ï¼š
```bash
./caddy-manager.sh restart
```

6. **å¦‚æœå‰ç«¯APIé—®é¢˜**ï¼š
```bash
./restart-frontend.sh
```

---

## ğŸ“ è·å–æ›´å¤šå¸®åŠ©

å¦‚æœä»¥ä¸Šè§£å†³æ–¹æ¡ˆæ— æ³•è§£å†³é—®é¢˜ï¼š

1. æ£€æŸ¥ç›¸å…³æ—¥å¿—æ–‡ä»¶ï¼š`logs/*.log`
2. è¿è¡Œè¯Šæ–­è„šæœ¬ï¼š`./status.sh`
3. æŸ¥çœ‹å…·ä½“ç«¯å£å ç”¨ï¼š`netstat -tlnp | grep :ç«¯å£å·`
4. æ£€æŸ¥è¿›ç¨‹çŠ¶æ€ï¼š`ps aux | grep [æœåŠ¡å]`

è®°ä½ï¼šå¤§å¤šæ•°é—®é¢˜éƒ½å¯ä»¥é€šè¿‡é‡å¯ç›¸å…³æœåŠ¡è§£å†³ï¼ 